image: cc_image:latest

stages:
  - singularity
  - image
  - shared
  - test
  - pages

Install Singularity:
  stage: singularity
  script:
    - SINGVER=2.5.1
    - yum install wget -y
    - wget https://github.com/sylabs/singularity/releases/download/$SINGVER/singularity-$SINGVER.tar.gz
    - tar xvf singularity-$SINGVER.tar.gz
    - cd singularity-$SINGVER
    - ./configure --prefix=/usr/local --sysconfdir=/etc
    - make
    - ls -l
    - ./bin/singularity --version
    - cd ..

Build Singularity Image:
  stage: image
  script:
    - echo "Test if we want to re-build the singularity image"
    - >
      if git diff HEAD~ --name-only|grep container; then
        ./singularity-$SINGVER/bin/singularity build cc.simg ./container/singularity/cc.def
      fi;

Shared Enviroment:
  stage: shared
  script:
    - yum update -y
    - yum install -y gcc g++ gcc-c++ gfortran gcc-gfortran cmake make git wget curl which vim bzip2 bzip2-devel file libXrender libXext postgresql-server postgresql-contrib
    - conda update -y setuptools
    - pip install --upgrade pip
    - conda install -y -c rdkit rdkit        
    - conda install -y -c openbabel openbabel
    - conda install -y mkl-service           
    - conda install -y anaconda-client       
    - conda install -y faiss-cpu -c pytorch  
    - conda install -y -c conda-forge hdbscan

Test Python 2.7.10:
  stage: test
  before_script:
    - conda create --name=py27 python=2.7.10 -y
    - source activate py27
  script:
    - cd package
    - pip install -r requirements_dev.txt
    - pytest

Test Python 3.6.8:
  stage: test
  before_script:
    - conda create --name=py36 python=3.6.8 -y
    - source activate py36
  script:
    - cd package
    - pip install -r requirements_dev.txt
    - pytest

Pages:
  stage: pages
  script:
  - pip install sphinx
  - pip install sphinx_rtd_theme
  - cd package/docs
  - sphinx-apidoc -o source ../chemicalchecker -f -e
  - make html
  - mv _build/html/ ../../public/
  - ls -l ../../public
  artifacts:
    paths:
    - public
  only:
  - master
