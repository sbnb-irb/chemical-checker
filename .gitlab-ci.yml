image: cc_image:latest
cache:
  paths:
    - cc.simg
    - cc_py36.simg

stages:
  - image
  - test
  - deploy

build_singularity_image_py27:
  stage: image
  script:
    - yum install squashfs-tools -y
    - rm -f cc.simg
    - singularity build cc.simg ./container/singularity/cc.def
  cache:
    paths:
      - cc.simg
      - cc_py36.simg
  only:
    changes:
      - container/singularity/cc.def

build_singularity_image_py36:
  stage: image
  script:
    - yum install squashfs-tools -y
    - rm -f cc_py36.simg
    - singularity build cc_py36.simg ./container/singularity/cc_py36.def
  cache:
    paths:
      - cc.simg
      - cc_py36.simg
  only:
    changes:
      - container/singularity/cc_py36.def

python_2.7.10:
  stage: test
  script:
    - ls -l
    - SINGULARITYENV_PYTHONPATH=/test/package singularity exec --cleanenv -B $PWD:/test cc.simg which python
    - SINGULARITYENV_PYTHONPATH=/test/package singularity exec --cleanenv -B $PWD:/test cc.simg pytest -s /test/package
  cache:
    paths:
      - cc.simg
      - cc_py36.simg

python_3.6.8:
  stage: test
  script:
    - ls -l
    - SINGULARITYENV_PYTHONPATH=/test/package singularity exec --cleanenv -B $PWD:/test cc_py36.simg which python
    - SINGULARITYENV_PYTHONPATH=/test/package singularity exec --cleanenv -B $PWD:/test cc_py36.simg pytest -s /test/package
  cache:
    paths:
      - cc.simg
      - cc_py36.simg


Pages:
  stage: deploy
  artifacts:
    paths:
    - test
  cache:
    paths:
      - cc.simg
  script:
  - SINGULARITYENV_PYTHONPATH=/test/package singularity exec --cleanenv -B $PWD:/test cc.simg bash -c 'cd /test/package/docs && sphinx-apidoc -o source ../chemicalchecker -f -e && make html'
  - cd package/docs
  - mv _build/html/ ../../public/
  - ls -l ../../public
  only:
  - master
