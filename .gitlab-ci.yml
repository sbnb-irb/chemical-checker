image: cc_image:latest

stages:
  - image
  - test
  - pages

build_singularity_image:
  stage: image
  script:
    - yum install squashfs-tools -y
    - >
      if git diff HEAD~ --name-only|grep singularity; then
        singularity build cc.simg ./container/singularity/cc.def
      fi;
  artifacts:
    paths:
    - cc.simg

python_2.7.10:
  stage: test
  script:
    - ls -l
    - cd package
    - 'curl --location --output cc.simg "http://gitlab.sbnb.org/api/v4/projects/$CI_PROJECT_ID/jobs/artifacts/master/download?job=build_singularity_image&job_token=$CI_JOB_TOKEN"'
    - singularity exec cc.simg pytest
  dependencies:
    - build_singularity_image


Pages:
  stage: pages
  script:
  - pip install sphinx
  - pip install sphinx_rtd_theme
  - cd package/docs
  - sphinx-apidoc -o source ../chemicalchecker -f -e
  - make html
  - mv _build/html/ ../../public/
  - ls -l ../../public
  artifacts:
    paths:
    - public
  only:
  - master
